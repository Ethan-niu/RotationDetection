# -*- coding: utf-8 -*-
from __future__ import division, print_function, absolute_import

import numpy as np

from configs._base_.models.retinanet_r50_fpn import *
from configs._base_.datasets.dota_detection import *
from configs._base_.schedules.schedule_1x import *
from alpharotate.utils.pretrain_zoo import PretrainModelZoo

# schedule
BATCH_SIZE = 1  # r3det only support 1
GPU_GROUP = '0,1,2'
NUM_GPU = len(GPU_GROUP.strip().split(','))
SAVE_WEIGHTS_INTE = 11725 * 2
DECAY_EPOCH = [8, 11, 20]
MAX_EPOCH = 12
WARM_EPOCH = 1 / 16.
DECAY_STEP = np.array(DECAY_EPOCH, np.int32) * SAVE_WEIGHTS_INTE
MAX_ITERATION = SAVE_WEIGHTS_INTE * MAX_EPOCH
WARM_SETP = int(WARM_EPOCH * SAVE_WEIGHTS_INTE)

# dataset
DATASET_NAME = 'DIOR-R'
CLASS_NUM = 20

# model
pretrain_zoo = PretrainModelZoo()
PRETRAINED_CKPT = pretrain_zoo.pretrain_weight_path(NET_NAME, ROOT_PATH)
TRAINED_CKPT = os.path.join(ROOT_PATH, 'output/trained_weights')

# bbox head
NUM_REFINE_STAGE = 1
NUM_SUBNET_CONV = 4
LEVEL = ['P3', 'P4', 'P5', 'P6', 'P7']
BASE_ANCHOR_SIZE_LIST = [32, 64, 128, 256, 512]
ANCHOR_STRIDE = [8, 16, 32, 64, 128]
ANCHOR_SCALES = [2 ** 0, 2 ** (1.0 / 3.0), 2 ** (2.0 / 3.0)]
ANCHOR_RATIOS = [1, 1 / 2, 2.]

# sample
REFINE_IOU_POSITIVE_THRESHOLD = [0.6, 0.7]
REFINE_IOU_NEGATIVE_THRESHOLD = [0.5, 0.6]

# loss
USE_IOU_FACTOR = False

VERSION = 'RetinaNet_DIOR_R_R3Det_2x_20211025'

"""
FLOPs: 1102856619;    Trainable params: 40940026

cls : basketballcourt|| Recall: 0.8909599254426841 || Precison: 0.12042577313094413|| AP: 0.8099598902845246
F1:0.8830271584256207 P:0.9570184983677911 R:0.8196644920782852
cls : Expressway-Service-area|| Recall: 0.8009216589861751 || Precison: 0.06551568154402895|| AP: 0.651407701767429
F1:0.6978177396610905 P:0.8233082706766918 R:0.6055299539170507
cls : groundtrackfield|| Recall: 0.9183023872679045 || Precison: 0.09196196143016522|| AP: 0.7423508548410919
F1:0.7771067203656316 P:0.7988795518207283 R:0.7564986737400531
cls : storagetank|| Recall: 0.5313556782671974 || Precison: 0.2341059540199536|| AP: 0.4834820805773951
F1:0.5712583911132735 P:0.8040556289332608 R:0.4430032960917769
cls : stadium|| Recall: 0.78125 || Precison: 0.09187959397969898|| AP: 0.575811104334594
F1:0.5807511333530898 P:0.6869918699186992 R:0.5029761904761905
cls : vehicle|| Recall: 0.33235735735735733 || Precison: 0.08511742821161111|| AP: 0.29584663021565455
F1:0.37367534570405436 P:0.671306209850107 R:0.2588963963963964
cls : bridge|| Recall: 0.37968327539590574 || Precison: 0.03354147473299894|| AP: 0.24594299129816632
F1:0.3171478894397471 P:0.5254691689008043 R:0.22711471610660486
cls : trainstation|| Recall: 0.6954813359528488 || Precison: 0.033637400228050174|| AP: 0.4201525137880078
F1:0.4856790189532913 P:0.5276497695852534 R:0.449901768172888
cls : baseballfield|| Recall: 0.7580081537565522 || Precison: 0.20625990491283677|| AP: 0.6775620544954889
F1:0.7463384571264463 P:0.9631675874769797 R:0.6092020966802563
cls : windmill|| Recall: 0.6867911941294196 || Precison: 0.09347618831434149|| AP: 0.5346523568421374
F1:0.6442167657634336 P:0.743993010048056 R:0.5680453635757171
cls : harbor|| Recall: 0.4885668276972625 || Precison: 0.025864861639187737|| AP: 0.26414703695110764
F1:0.35923647339655196 P:0.42498900131984163 R:0.3111111111111111
cls : golffield|| Recall: 0.8626086956521739 || Precison: 0.053053802545726815|| AP: 0.7286412145599265
F1:0.7632526154082988 P:0.8378378378378378 R:0.7008695652173913
cls : dam|| Recall: 0.570631970260223 || Precison: 0.015692087507667145|| AP: 0.2321251950449793
F1:0.35698881287818446 P:0.40714285714285714 R:0.31784386617100374
cls : tenniscourt|| Recall: 0.8606836442870761 || Precison: 0.21292365743548278|| AP: 0.8050328868751124
F1:0.8553598258693578 P:0.9516182849516183 R:0.7767942257932725
cls : ship|| Recall: 0.6664866708349911 || Precison: 0.2337642919088109|| AP: 0.5757955870609218
F1:0.6404098170302682 P:0.7850482713095139 R:0.5407832660717331
cls : overpass|| Recall: 0.5673400673400674 || Precison: 0.03451807845948991|| AP: 0.4419986890951201
F1:0.5178261338808476 P:0.765934065934066 R:0.39113355780022446
cls : airport|| Recall: 0.6501501501501501 || Precison: 0.023976964394484743|| AP: 0.324005004748103
F1:0.4052428177225937 P:0.3937677053824363 R:0.4174174174174174
cls : airplane|| Recall: 0.5392109108621529 || Precison: 0.22580316165221825|| AP: 0.4961059266374045
F1:0.5941798613507122 P:0.8636785880167208 R:0.45287384315635654
cls : chimney|| Recall: 0.7817652764306499 || Precison: 0.10810085836909872|| AP: 0.7257398907103826
F1:0.8327747239710434 P:0.9703225806451613 R:0.7293889427740058
cls : Expressway-toll-station|| Recall: 0.6177325581395349 || Precison: 0.029462738301559793|| AP: 0.5177292227087199
F1:0.6269185988485548 P:0.9261363636363636 R:0.4738372093023256
mAP is : 0.5274244416418135
"""


